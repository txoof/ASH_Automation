# ASH SIS Automation

Automation plugins and scripts for ASH PowerSchool SIS.

## Overview

PowerSchool SIS generates reports on a schedule set in the Data Export Manager (*Functions > Importing & Exporting > Data Export Manager*). Reports are transmitted to an internal SSH host (see [internal documentation](https://drive.google.com/drive/folders/1JPArXP_7C58uMpqMbwHHK_5DDGpmmQw2)).

Documents deposited on the SSH host are processed and forwarded on to the appropriate user groups with links to documentation and instructions particular to the document. All documents should only be mailed to google group addresses within the domain. Distribution lists are maintained exclusively through the google groups.

Reports are poduced through PowerSchool PowerQueries.
## Report setup

Create a report using the Data Export Manager to choose a Named Query (NQ).

... additional instructions here ...

When setting the report name follow the convetion below:

```text
                  ┌──────────────────────────────────┐
                  │ user_services-_-new_users-%d.csv │
                  └────────────────┬─────────────────┘
        ┌─────────────┬───────────┬┴────────────┬──────────────┐
    recipient     delimiter   file name   date shortcut   file suffix
┌───────┴───────┐  ┌──┴──┐  ┌─────┴─────┐     ┌─┴──┐        ┌──┴───┐
│ user_services │  │ -_- │  │ new_users │     │ %d │        │ .csv │
└───────────────┘  └─────┘  └───────────┘     └────┘        └──────┘

```

* recipient: google group that will receive the report
* delimiter: always `-_-`
* file name: name of report that will be appened to the email
* date shortcut: always `%d`
  * the Data Export Manager will substitute the current date when running scheduled jobs.
* file suffix: always `.csv`

## Email setup

Email is forwarded from the SSH host to a google group. The forwarding address is contained within the report name

To help prevent malicious data exfiltration from the SIS to external email addresses, reports will only be forwarded to email addresses that follow the format `recipient_sis_reports@host.com`. `_sis_reports@host.com` are set in the in the variable `email_group_suffix` set in the [`parse_ps_reports.sh`](./parse_ps_reports/parse_ps_reports.sh) script.

Google groups are set so only Google admins can create groups that match the pattern below. All other groups generated by users are set to *group_name*_**group@ash.nl**

### Google Groups Settings

Google groups must be created by a domain administrator from the [Google Admin Groups Console](https://admin.google.com/ac/groups). 
#### General

* *Group name*: ASH Name Of Group
  * Use a descriptive name that indicates the purpose of the group
* *Group Email*: *group_name*_**sis_reports@ash.nl** 
  * See [Group Naming Convention](#groupnamingconvention) below
* *Group description*: add link to this documentation (https://github.com/txoof/ASH_Automation)

#### <a name="groupnamingconvention"></a>Group Naming Convention

```text
        ┌─────────────────────────────────────┐
        │ user_serivices_sis_reports@host.com │
        └─────────────────┬───────────────────┘
         ┌───── ──────────┴┬────────────────┐
    recipient     email_group_suffix     domain
┌────────┴──────┐   ┌──────┴───────┐  ┌─────┴─────┐
│ user_services │   │ _sis_reports │  │ @host.com │
└───────────────┘   └──────────────┘  └───────────┘
```

* `report name`: the name of the report and the first element of the group name
  * Provided by the incoming report
* `email_group_suffix`: group suffix common between all reports
  * Set in `email_group_sufix`

#### Allow external members

* *People outside the organization can be members*: OFF
* *Who can view conversations*: Group members
* *Who can post*: Anyone on the web 
  * This is necessary to allow the script to send email
* *Who can view members*: Group members

## Dependencies

The following dependencies are required on the SFTP server in a Debian based environment.

### Debian Packages

* uuencode provided by [sharutils](https://packages.debian.org/bullseye/sharutils)

## TO DO

- [x] Set up sismailer user on SSH host
- [ ] Setup rrsync on SSH host NOPE
- [ ] Document SSH configuration
- [ ] Add automation scripts to sismailer
- [ ] Setup cron job for sis mailer
- [ ] Write standard, individual text for mailer
- [ ] Set up Google groups
- [ ] more robust parsing of the incoming report name delimiter using a regex
- [ ] some sort of external monitoring
- [ ] some sort of internal monitoring
- [ ] clean up old reports in $report_archive on a regular basis

