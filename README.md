# ASH SIS Automation

Automation plugins and scripts for ASH PowerSchool SIS.

## Overview

PowerSchool SIS generates reports on a schedule set in the Data Export Manager (*Functions > Importing & Exporting > Data Export Manager*). Reports are transmitted to an internal SSH host (see [internal documentation](https://drive.google.com/drive/folders/1JPArXP_7C58uMpqMbwHHK_5DDGpmmQw2)).

Documents deposited on the SSH host are processed and forwarded on to the appropriate user groups with links to documentation and instructions particular to the document. All documents should only be mailed to google group addresses within the domain. Distribution lists are maintained exclusively through the google groups.

Reports are produced through PowerSchool PowerQueries. For more information on updating and maintaining the PowerQuery reports see the [sis_automation README](./sis_automation/README.md) in this repository.

## Report setup

Create a report using the Data Export Manager to choose using the appropriate `com.txoof.ashautomation` named query (NQ). When done make sure to save the template. 

### Export Summary and Output Options

#### Export Format

* Export Filename: `recipient-_-file_name-%d.csv` (see [Export Filename Convention](#export-filename-convention) below)
* Line Delimiter: `CR/LF`
* Field Delimiter: `Comma` (only ***monsters*** use Tabs)
* Character Set: `UTF-8`

#### Export Options

* Include Column Headers: ğŸ—¹
* Surround "field values" in Quotes: â˜

### Save Export Template

* Name: descriptive name that identifies the purpose of the export template
* Description: brief description of the purpose and audience

#### Example

* Name: A.Automation: New Student Enrolment Report
* Description: ASH Automation new student enrollment report for division offices, it support, powerschool admin, etc.

#### <a name="exportfilenameconvention"></a>Export Filename Convention

```text
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ user_services-_-new_users-%d.csv â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    recipient     delimiter   file name   date shortcut   file suffix
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”     â”Œâ”€â”´â”€â”€â”        â”Œâ”€â”€â”´â”€â”€â”€â”
â”‚ user_services â”‚  â”‚ -_- â”‚  â”‚ new_users â”‚     â”‚ %d â”‚        â”‚ .csv â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”˜

```

* recipient: google group that will receive the report
* delimiter: always `-_-`
* file name: name of report that will be appened to the email
* date shortcut: always `%d`
  * the Data Export Manager will substitute the current date when running scheduled jobs.
* file suffix: always `.csv`

## Email setup

Email is forwarded from the SSH host to a google group. The forwarding address is contained within the report name. See the [Group Naming Convention](#group-naming-convention) below.

To help prevent malicious data exfiltration from the SIS to external email addresses, reports will only be forwarded to email addresses that follow the format `recipient_sis_reports@host.com`. `_sis_reports@host.com` are set in the in the variable `email_group_suffix` in the [`parse_ps_reports.sh`](./parse_ps_reports/parse_ps_reports.sh) script.

Google groups in the domain are configured so only Google admins can create groups that match the pattern below. All other groups generated by users are set to *group_name*_**group@ash.nl**

### Google Groups Settings

Google groups must be created by a domain administrator from the [Google Admin Groups Console](https://admin.google.com/ac/groups). Use the settings below when creating a new group for use with automation.

#### General

* *Group name*: ASH *Name Of Group*
  * Use a descriptive name that indicates the purpose of the group
* *Group Email*: *group_name*_**sis_reports@ash.nl** 
  * See [Group Naming Convention](#group-naming-convention) below
* *Group description*: add link to this documentation (https://github.com/txoof/ASH_Automation)

#### Group Naming Convention

```text
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ user_serivices_sis_reports@host.com â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    recipient     email_group_suffix     domain
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚ user_services â”‚   â”‚ _sis_reports â”‚  â”‚ @host.com â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

* `report name`: the name of the report and the first element of the group name
  * Provided by the incoming report
* `email_group_suffix`: group suffix common between all reports
  * Set in `email_group_sufix`

#### Access type
* Custom

#### Access settings
| Access Settings               | Group Owners | Group Managers | Group Members | Entire Organization | External |
|-------------------------------|:------------:|:--------------:|:-------------:|:-------------------:|:--------:|
| Who can contact group owners  |       âœ”ï¸      |        âœ”ï¸       |       âœ”ï¸       |          âœ”ï¸          |     âœ”ï¸    |
| Who can view conversations    |       âœ”ï¸      |        âœ”ï¸       |       âœ”ï¸       |                     |          |
| Who can post                  |       âœ”ï¸      |        âœ”ï¸       |       âœ”ï¸       |          âœ”ï¸          |     âœ”ï¸    |
| Who can view members          |       âœ”ï¸      |        âœ”ï¸       |       âœ”ï¸       |                     |          |
| Who can manage members        |       âœ”ï¸      |        âœ”ï¸       |               |                     |          |

#### Who can join the group
- [ ] Anyone in the organization can ask 
- [ ] Anyone in the organization can join
- [x] Only invited users 
#### Allow members outside your organization

- [ ] Allow members outside your organization

#### Member restriction
- [x] No restrictions
- [ ] Restrict membership

#### Add members

Direct add members as needed. Members should be added as *Members*.

## Dependencies

The following dependencies are required on the SFTP server in a Debian based environment.

### Debian Packages

* uuencode provided by [sharutils](https://packages.debian.org/bullseye/sharutils)


## Report setup

Report names need to be formatted as `destination_group-_-report_name.csv`. The `destination_group` must match a google group in the form of `destination_group_sis_reports@ash.nl`. The delimiter between the destination group and the report name must always be `-_-`. 
## Email setup

All outgoing emails will get `sis_textbody/default_body.txt` appended to the email.

Specific text will be added to outgoing email. 

## TO DO

- [x] Set up sismailer user on SSH host
- [ ] ~~Setup rrsync on SSH host~~
- [ ] Document SSH configuration
- [x] Add automation scripts to sismailer
- [ ] Setup cron job for sis mailer
<<<<<<< HEAD
- [x] Write standard, individual text for mailer
- [x] Set up Google groups
- [ ] more robust parsing of the incoming report name delimiter using a regex
- [ ] some sort of external monitoring
- [ ] some sort of internal monitoring
- [ ] clean up old reports in $report_archive on a regular basis
=======
- [ ] Write standard, individual text for mailer
- [ ] Set up Google groups
- [ ] more robust parsing of the incoming report name delimiter using a regex

